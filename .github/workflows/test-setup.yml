name: Nix Setup Testing

on:
  push:
    branches: [ '*' ]
  pull_request:
    branches: [ '*' ]

jobs:
  test-unix:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - name: Run setup script
        run: |
          bash setup.sh --c
      - name: Run tests
        run: |
          bash tests/unix/test_install.sh
          bash tests/unix/test_env.sh
          bash tests/unix/test_config.sh

  test-windows:
    name: Test on Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run setup script
        shell: pwsh
        run: |
          .\setup.ps1 -CI_MODE
      - name: Run tests
        shell: pwsh
        run: |
          .\tests\windows\test_install.ps1
          .\tests\windows\test_env.ps1
          .\tests\windows\test_config.ps1

  all-tests-passed:
    needs: [test-unix, test-windows]
    runs-on: ubuntu-latest
    steps:
      - run: echo "All setup tests passed successfully!"