name: Nix Setup Testing

on:
  push:
    branches: [ '*' ]
  pull_request:
    branches: [ '*' ]

jobs:
  test-unix:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, macos-latest ]
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Debug Nix installation
        run: |
          echo "HOME: $HOME"
          echo "PATH: $PATH"
          nix --version
          nix-env --version
          ls -la $HOME/.nix-profile/etc/profile.d || true
          ls -la /nix/var/nix/profiles/default/etc/profile.d || true
          env | grep NIX

      - name: Run setup script
        run: |
          bash setup.sh -c
        continue-on-error: true

      - name: Debug after setup
        if: always()
        run: |
          echo "PATH after setup: $PATH"
          which nix || true
          nix --version || true
          cat setup.sh || true
          echo "Last 20 lines of setup.sh:"
          tail -n 20 setup.sh

      - name: Run tests
        if: success()
        run: |
          bash tests/unix/test_install.sh
          bash tests/unix/test_env.sh
          bash tests/unix/test_config.sh

  test-windows:
    name: Test on Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
          install_options: --no-daemon
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Debug Nix installation
        shell: pwsh
        run: |
          echo "HOME: $env:USERPROFILE"
          echo "PATH: $env:PATH"
          nix --version
          nix-env --version
          Get-ChildItem $env:USERPROFILE\.nix-profile\etc\profile.d
          Get-ChildItem C:\nix\var\nix\profiles\default\etc\profile.d
          Get-ChildItem env: | Where-Object { $_.Name -like "NIX*" }

      - name: Run setup script
        shell: pwsh
        run: |
          .\setup.ps1 -CI_MODE
        continue-on-error: true

      - name: Debug after setup
        if: always()
        shell: pwsh
        run: |
          echo "PATH after setup: $env:PATH"
          Get-Command nix
          nix --version
          Get-Content setup.ps1
          echo "Last 20 lines of setup.ps1:"
          Get-Content setup.ps1 -Tail 20

      - name: Run tests
        if: success()
        shell: pwsh
        run: |
          .\tests\windows\test_install.ps1
          .\tests\windows\test_env.ps1
          .\tests\windows\test_config.ps1

  all-tests-passed:
    needs: [ test-unix, test-windows ]
    runs-on: ubuntu-latest
    steps:
      - run: echo "All setup tests passed successfully!"